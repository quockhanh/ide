namespace {{{rootNamespace}}}.Support;

{{!-- Use parital class for easy copy in and out of the template --}}

{{!-- This partial should contain code with hbs parameters --}}
/// <summary>
/// Base class RM test suite
/// </summary>
public abstract partial class TestSuiteBase : PageTest
{
    [TestInitialize]
    public new async Task PageSetup()
    {        
        {{#if testIdAttributeName}}
        Playwright.Selectors.SetTestIdAttribute("{{testIdAttributeName}}");
        {{/if}}
        await base.PageSetup();
    }
}


{{!-- This partial should contain code that is static (no hbs parameters).
    i.e the whole class can be copy without changing
 --}}
 
public abstract partial class TestSuiteBase : PageTest
{
    /// <summary>
    /// Default Playwright video extension
    /// </summary>
    const string VideoExtension = ".webm";

    /// <summary>
    /// Videos folder (in the build output folder)
    /// </summary>
    const string VideoDir = "videos";
    /// <summary>
    /// Folder to store the videos we want to keep
    /// </summary>
    readonly string KeepVideoDir = Path.Combine(VideoDir, "keep");
    /// <summary>
    /// Screenshots folder (in the build output folder)
    /// </summary>
    const string ScreenshotDir = "screenshots";

    public override BrowserNewContextOptions ContextOptions() => new()
    {
        // If RecordVideoMode is Off, then don't record videos
        RecordVideoDir = EnvironmentSettings.RecordVideoMode == RecordVideoMode.Off ? null : VideoDir,
        ViewportSize = new ViewportSize() { Width = 1920, Height = 1080 }
    };

    [TestCleanup]
    public void Cleanup()
    {
        SaveScreenshots();
        Context.CloseAsync().Wait();
        SaveRecordings().Wait();
    }

    /// <summary>
    /// Deletes existing recordings that were generated by previous tests (if any)
    /// </summary>
    private void DeleteExistingVideos()
    {
        if (!Directory.Exists(VideoDir))
        {
            return;
        }

        if (EnvironmentSettings.RecordVideoMode == RecordVideoMode.Off)
        {
            return;
        }

        foreach (string file in Directory.EnumerateFiles(VideoDir, "*.webm", SearchOption.AllDirectories))
        {
            File.Delete(file);
        }
    }

    /// <summary>
    /// Deletes existing screenshots that were generated by previous tests (if any)
    /// </summary>
    private void DeleteExistingScreenshots()
    {
        if (!Directory.Exists(ScreenshotDir))
        {
            return;
        }

        if (!EnvironmentSettings.TakeScreenshotOnError)
        {
            return;
        }

        foreach (string file in Directory.EnumerateFiles(ScreenshotDir, "*.png", SearchOption.AllDirectories))
        {
            File.Delete(file);
        }
    }

    private string GetRecordingFileName()
    {
        string baseName = $"{GetBaseTestName()}";

        if (IsTestSuccess())
        {
            return $"{baseName}{VideoExtension}";
        }

        return $"{baseName}_error{VideoExtension}";
    }

    private bool ShouldSaveRecordings()
    {
        if (EnvironmentSettings.RecordVideoMode == RecordVideoMode.Off)
        {
            return false;
        }

        if (EnvironmentSettings.RecordVideoMode == RecordVideoMode.RetainOnFailure)
        {
            if (IsTestSuccess())
            {
                return false;
            }
        }

        if (EnvironmentSettings.RecordVideoMode == RecordVideoMode.On)
        {
            // Proceed
        }
        return true;
    }

    private void CreateScreenshotDir()
    {

        if (!Directory.Exists(ScreenshotDir))
        {
            Directory.CreateDirectory(ScreenshotDir);
        }
    }

    private void CreateKeepVideoDir()
    {

        if (!Directory.Exists(KeepVideoDir))
        {
            Directory.CreateDirectory(KeepVideoDir);
        }
    }

    private async Task SaveRecordings()
    {
        if (!ShouldSaveRecordings())
        {
            return;
        }

        CreateKeepVideoDir();

        string autoNameVideo = await Page.Video!.PathAsync();

        string videoFileName = GetRecordingFileName();

        string moveToFileName = Path.Combine(KeepVideoDir, videoFileName);

        if (File.Exists(moveToFileName))
        {
            File.Delete(moveToFileName);
        }

        File.Move(autoNameVideo, moveToFileName);
    }

    private void SaveScreenshots()
    {
        if (IsTestSuccess())
        {
            return;
        }

        if (!EnvironmentSettings.TakeScreenshotOnError)
        {
            return;
        }
        
        string screenshotFile = Path.Combine(ScreenshotDir, $"{GetBaseTestName()}_error.png");

        if (File.Exists(screenshotFile))
        {
            File.Delete(screenshotFile);
        }

        this.Page.ScreenshotAsync(new PageScreenshotOptions { Path = screenshotFile, FullPage = true }).Wait();
    }

    private string GetBaseTestName()
    {
        return $"{TestContext.ManagedType}_{TestContext.ManagedMethod}";
    }

    private bool IsTestSuccess()
    {
        return (TestContext.CurrentTestOutcome == UnitTestOutcome.Passed);
    }
}
